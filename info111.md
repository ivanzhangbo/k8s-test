はい、承知いたしました。ご指定の内容をMarkdown形式にまとめます。

---

# Cloud LoggingおよびCloud Monitoring 方式設計

## ログ監視（Cloud Logging）の設計

### 対象ログの範囲
GKEクラスタでデフォルトで統合されているCloud Loggingを利用し、以下のログを収集対象とします。
* **アプリケーションログ**: アプリケーションが出力するイベントやエラーログ
* **アクセスログ**: HTTPリクエストなどの記録
* **コンテナログ**: コンテナの標準出力・標準エラーに記録されるログ

各ノードのログ収集エージェントが自動的にログを取得し、クラスタ名やPod名などのメタデータを付与してCloud Loggingに送信します。

### ログ収集とテナント分離
本システムはマルチテナント構成のため、ログはテナント（Namespace）ごとに分離して管理します。
* **テナント識別**: 各テナントに固有のKubernetes Namespaceを割り当て、ログエントリの `resource.labels.namespace_name` でテナントを識別します。
* **分離方法**: Cloud Loggingの**ログルーター**と**ログシンク**を活用します。
* **具体例**: テナントA用のログシンクを作成し、フィルタに `resource.labels.namespace_name="テナントAのNamespace"` と指定することで、テナントAのログのみを抽出します。このシンクをテナントごとに作成し、ログを分離します。

### ログの集約先と転送
各テナントのログは、一元管理のために**監視集約用プロジェクト**へ転送・保存します。
* **転送設定**: GKEクラスタが属するメインプロジェクトでテナント別のログシンクを作成し、転送先を監視集約プロジェクトのCloud Loggingに設定します。
* **重複保存の防止**: メインプロジェクト側の `_Default` ログシンクに**除外フィルタ**を設定し、テナント関連のログがメインプロジェクトに残らないようにします。これにより、不要なコスト発生を回避します。

### ログの閲覧と可視化
収集したログは、監視集約プロジェクトのCloud Logging上でテナント別に可視化・分析します。
* **閲覧方法**: ログエクスプローラでNamespaceラベル等でフィルタリングし、特定テナントのログを抽出・閲覧します。
* **アクセス制御**: 必要に応じて、テナントごとのログビューや専用ログバケットを作成し、IAM権限でアクセスを制御することも可能です。
* **活用**: リアルタイムにログを検索・分析できるほか、ログベースの指標を定義して特定パターンのログ（例: エラーログの出現回数）を定量的にモニタリングできます。

---

## メトリクス監視（Cloud Monitoring）の設計

### 対象メトリクスと収集方法
GKEクラスタおよび各テナントアプリケーションに関する主要なメトリクスを網羅的に収集します。
* **Podリソース**: CPU使用率、メモリ使用量、ディスクIO、ネットワークトラフィックなど。GKEのシステムメトリクスとしてデフォルトで収集されます。
* **ロードバランサ (GCLB)**: リクエスト数、バックエンド応答レイテンシ、HTTPステータス別エラー率 (2xx/4xx/5xx) など。Cloud Load Balancingの指標として自動収集されます。
* **SLO監視**: サービスの可用性やエラーレートを把握するためのSLI（リクエスト成功率、平均応答時間など）を設定し、Cloud Monitoringの**サービス監視 (SLOモニタリング)** 機能で目標達成度を計測します。
* **外形監視（合成モニタリング）**: Cloud Monitoringの**稼働時間チェック (Uptime Check)** 機能を利用し、公開エンドポイントの正常性を外部から定期的に監視します。

### メトリクスの収集構成
GKEクラスタはCloud Monitoringとデフォルトで統合されており、特別なエージェントは不要です。
* **システムメトリクス**: GKEノード上のMonitoringエージェントがPodやノードのリソース利用状況を収集します。
* **LBメトリクス**: Google Cloudが提供するマネージド指標として自動的に収集されます。
* **外形監視**: Cloud Monitoringのアップタイムチェック機能が、分散された複数の地域からHTTPヘルスチェックを行います。

### テナント別メトリクスの分離と集約
ログと同様に、メトリクスもテナントごとの分離と集中集約を両立させます。
* **集約方法**: 監視集約用プロジェクトをCloud Monitoringの**スコーピングプロジェクト**として設定し、GKEクラスタが稼働するプロジェクトをスコープに追加します。これにより、複数プロジェクトの指標を一元的に参照できます。
* **分離方法**: 各メトリクスデータには `namespace_name` などのラベルが含まれているため、ダッシュボードやアラートポリシーのクエリ内でフィルタ (`resource.labels.namespace_name="tenant-a"`) を指定することで、テナントごとに論理的な分離が可能です。

### ダッシュボードと可視化
収集したメトリクスはCloud Monitoringのダッシュボードで可視化します。
* **テナント別ビュー**: テナントごとにダッシュボードを作成し、主要指標（Pod CPU使用率、エラー率、応答時間など）をウィジェットとして配置します。
* **共通ビュー**: SLO達成状況を示すダッシュボードや、複数テナントのステータスを一覧できる運用者向けダッシュボードも用意します。
* **ログベース指標**: Cloud Loggingから作成した指標（例: アプリケーションエラー発生回数）もグラフ化してダッシュボードに追加できます。

### アラートポリシーと通知設定
重要なメトリクスの異常を検知し、運用チームへ通知するアラートポリシーを設定します。
* **リソース高負荷アラート**: PodのCPUやメモリ使用率が一定のしきい値（例: 連続5分間80%超）を超えた場合に通知します。
* **アプリケーションエラーアラート**: HTTP 5xxエラー率の増加や、ログ上で致命的エラーが多発した場合に通知します。
* **外形監視アラート**: 稼働時間チェックが連続して失敗した場合に通知します。
* **SLO違反アラート**: エラーバジェットが一定割合を消費し、SLO目標の未達リスクが高まった時点で早期に警告します。

これらのポリシーは監視集約プロジェクトで一元管理し、通知先（Notification Channel）としてMicrosoft TeamsなどをWebhook経由で設定します。

---

## 参考
本方式設計は、GKEマルチテナント環境におけるCloud Logging/Monitoringのベストプラクティスに準拠しています。ログ分離には**ログルーター/シンク**を、メトリクス集約には**指標スコープ**を活用することで、運用の一元管理とテナントごとの独立性を両立した監視基盤を構築します。アラートのしきい値などの各種パラメータは、今後の運用実績に応じて継続的にチューニングします。
